<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Real â€“ AlmacÃ©n Cigarro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#f4f4f4;
  padding:20px;
}
h2{ color:#00416A; text-align:center; }
table{
  width:100%;
  border-collapse:collapse;
  background:white;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:13px;
}
th{ background:#00416A; color:white; }
input[type=number]{ width:90px; }
button{
  background:#00416A;
  color:white;
  border:none;
  border-radius:6px;
  padding:6px 12px;
  cursor:pointer;
}
.marca-row{
  background:#d9e7f5;
  font-weight:bold;
}
.positivo{color:green;font-weight:bold;}
.negativo{color:red;font-weight:bold;}
</style>
</head>

<body>

<h2>Inventario Real â€“ AlmacÃ©n Cigarro</h2>

<table>
<thead>
<tr>
  <th>CÃ³digo</th>
  <th>DescripciÃ³n</th>
  <th>Inicial</th>
  <th>Entradas</th>
  <th>Salidas</th>
  <th>Actual</th>
  <th>Existencia real</th>
</tr>
</thead>
<tbody id="tablaInventario"></tbody>
</table>

<br>
<div style="text-align:center">
  <button onclick="guardarAjustes()">Guardar ajustes realizados</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, onSnapshot, setDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let productos={}, entradas={}, salidas={}, iniciales={};

const norm = c => (c||"").toString().trim().padStart(12,"0");

// ================= PRODUCTOS (CIGARROS) =================
getDocs(collection(db,"productos")).then(s=>{
  s.forEach(d=>{
    const x=d.data();
    if(x.activo!==true || x.departamento!=="CIGARROS") return;

    productos[norm(x.codigoBarra||x.productoId)] = {
      descripcion:x.descripcion||x.concepto||"-",
      marca:x.marca||"SIN MARCA"
    };
  });
});

// ================= ENTRADAS =================
onSnapshot(collection(db,"almacenes/almacen_cigarro/entradas"),s=>{
  entradas={};
  s.forEach(d=>{
    (d.data().items||[]).forEach(i=>{
      const c=norm(i.productoId||i.codigo);
      entradas[c]=(entradas[c]||0)+Number(i.cantidadTotal||0);
    });
  });
  dibujar();
});

// ================= SALIDAS =================
onSnapshot(collection(db,"almacenes/almacen_cigarro/salidas1.0"),s=>{
  salidas={};
  s.forEach(d=>{
    (d.data().productos||[]).forEach(i=>{
      const c=norm(i.codigo);
      salidas[c]=(salidas[c]||0)+Number(i.cantidad||0);
    });
  });
  dibujar();
});

// ================= INVENTARIO INICIAL =================
onSnapshot(collection(db,"almacenes/almacen_cigarro/inventario_base"),s=>{
  iniciales={};
  s.forEach(d=>{
    iniciales[norm(d.id)] = Number(d.data().existencia||0);
  });
  dibujar();
});

// ================= DIBUJAR =================
function dibujar(){
  const t=document.getElementById("tablaInventario");
  t.innerHTML="";

  const codigos=new Set([
    ...Object.keys(productos),
    ...Object.keys(entradas),
    ...Object.keys(salidas),
    ...Object.keys(iniciales)
  ]);

  const grupos={};

  codigos.forEach(c=>{
    const p=productos[c];
    if(!p) return;

    const ini=iniciales[c]||0;
    const ent=entradas[c]||0;
    const sal=salidas[c]||0;
    const act=ini+ent-sal;

    if(!grupos[p.marca]) grupos[p.marca]=[];
    grupos[p.marca].push({c,desc:p.descripcion,ini,ent,sal,act});
  });

  Object.keys(grupos).sort().forEach(m=>{
    t.innerHTML+=`<tr class="marca-row"><td colspan="7">${m}</td></tr>`;
    grupos[m].forEach(i=>{
      t.innerHTML+=`
      <tr>
        <td>${i.c}</td>
        <td>${i.desc}</td>
        <td>${i.ini}</td>
        <td>${i.ent}</td>
        <td>${i.sal}</td>
        <td class="${i.act<0?'negativo':'positivo'}">${i.act}</td>
        <td><input type="number" id="real_${i.c}" placeholder="${i.act}"></td>
      </tr>`;
    });
  });
}

// ================= GUARDAR AJUSTES =================
window.guardarAjustes = async ()=>{
  const inputs=document.querySelectorAll("input[id^='real_']");
  let total=0;

  for(const i of inputs){
    if(i.value==="") continue;

    const c=i.id.replace("real_","");
    const fisico=Number(i.value);
    if(isNaN(fisico)) continue;

    const ent=entradas[c]||0;
    const sal=salidas[c]||0;

    // ðŸ”‘ ESTA ES LA CLAVE
    const nuevoInicial = fisico - ent + sal;

    await setDoc(
      doc(db,"almacenes/almacen_cigarro/inventario_base",c),
      {
        existencia:nuevoInicial,
        actualizadoEn:new Date(),
        motivo:"AJUSTE_MANUAL"
      }
    );

    total++;
  }

  alert(total===0
    ? "No se realizaron ajustes"
    : "Ajustes aplicados correctamente"
  );
};
</script>

</body>
</html>
